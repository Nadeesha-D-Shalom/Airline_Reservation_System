<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loyalty Management System</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #f4f7ff;
            --panel: #ffffff;
            --ink: #0e1726;
            --muted: #5b6b8b;
            --primary: #355cff;
            --primary-2: #7aa2ff;
            --ok: #16a34a;
            --warn: #d94848;
            --bd: #e6ebff;
            --bd-2: #d7def7;
            --shadow: 0 8px 28px rgba(19,35,75,.08);
            --radius: 14px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; }
        body {
            margin: 0;
            background: var(--bg);
            color: var(--ink);
            font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.5;
        }
        header {
            position: sticky;
            top: 0;
            z-index: 10;
            background: rgba(255,255,255,.85);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid var(--bd);
        }
        .bar {
            max-width: 1400px;
            margin: auto;
            padding: 14px 18px;
            display: flex;
            gap: 14px;
            align-items: center;
            justify-content: space-between;
        }
        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .logo {
            width: 34px;
            height: 34px;
            border-radius: 10px;
            background: linear-gradient(135deg, #7aa2ff, #b7c9ff);
            box-shadow: inset 0 0 0 1px #a4b7ff;
        }
        .brand h1 {
            margin: 0;
            font-size: 18px;
            font-weight: 700;
        }
        .badge {
            font-size: 12px;
            color: #304173;
            background: #eef3ff;
            border: 1px solid var(--bd-2);
            padding: 6px 10px;
            border-radius: 999px;
            font-weight: 600;
        }
        main {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 18px;
        }
        .dashboard-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--bd);
        }
        .dashboard-tab {
            padding: 12px 20px;
            cursor: pointer;
            font-weight: 600;
            color: var(--muted);
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        .dashboard-tab.active {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
        }
        .toolbar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .search {
            position: relative;
            flex: 1 1 380px;
        }
        .search input {
            width: 100%;
            padding: 12px 42px 12px 38px;
            border-radius: 12px;
            border: 1px solid var(--bd);
            background: #fff;
            outline: none;
            transition: box-shadow .2s ease, border .2s ease;
            box-shadow: var(--shadow);
            font-family: inherit;
        }
        .search input:focus {
            border: 1px solid var(--primary-2);
            box-shadow: 0 0 0 4px #355cff22, var(--shadow);
        }
        .search .icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            opacity: .6;
            user-select: none;
        }
        .actions { display: flex; gap: 8px; }
        button {
            border: 0;
            border-radius: 10px;
            padding: 10px 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform .12s ease, box-shadow .2s ease, opacity .2s ease, background .2s ease;
            font-family: inherit;
            font-size: 14px;
        }
        .btn-ghost {
            background: #fff;
            border: 1px solid var(--bd);
            color: var(--ink);
        }
        .btn-ghost:hover {
            background: #f9fbff;
            transform: translateY(-1px);
        }
        .btn-primary {
            background: linear-gradient(180deg, #355cff, #2f52e6);
            color: #fff;
            box-shadow: 0 6px 16px rgba(53,92,255,.3);
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 20px rgba(53,92,255,.4);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: var(--panel);
            border: 1px solid var(--bd);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
        }
        .stat-card h3 {
            font-size: 14px;
            color: var(--muted);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }
        .stat-value {
            font-size: 28px;
            font-weight: 800;
            color: var(--ink);
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 14px;
            color: var(--muted);
        }
        .panel {
            background: var(--panel);
            border: 1px solid var(--bd);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            animation: fade .35s ease;
        }
        @keyframes fade {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: none; }
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        thead th {
            text-align: left;
            background: #f6f8ff;
            color: #2c3d6b;
            border-bottom: 1px solid var(--bd);
            padding: 12px 14px;
            font-size: 13px;
            letter-spacing: .2px;
            font-weight: 600;
        }
        tbody td {
            padding: 14px;
            border-bottom: 1px solid #f1f4ff;
            vertical-align: top;
        }
        tbody tr:hover {
            background: #fafcff;
        }
        .status {
            font-size: 12px;
            font-weight: 800;
            padding: 6px 10px;
            border-radius: 999px;
            display: inline-flex;
            gap: 6px;
            align-items: center;
        }
        .ok {
            background: #eaf7ee;
            color: #0d6a2b;
            border: 1px solid #b8e7c8;
        }
        .warn {
            background: #fdecec;
            color: #8d1e1e;
            border: 1px solid #f6c0c0;
        }
        .ops { display: flex; gap: 8px; }
        .btn-mini {
            padding: 7px 10px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
        }
        .btn-edit {
            background: #ecf4ff;
            border: 1px solid #cfe0ff;
            color: #2a4fb0;
        }
        .btn-edit:hover {
            background: #e4eeff;
            transform: translateY(-1px);
        }
        .btn-del {
            background: #fff0f1;
            border: 1px solid #f7c7cd;
            color: #a32424;
        }
        .btn-del:hover {
            background: #ffe8ea;
            transform: translateY(-1px);
        }
        .empty {
            text-align: center;
            padding: 24px;
            color: var(--muted);
        }
        .promotions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .promo-card {
            background: var(--panel);
            border: 1px solid var(--bd);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .promo-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(19,35,75,.12);
        }
        .promo-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        .promo-title {
            font-weight: 700;
            font-size: 16px;
            color: var(--ink);
        }
        .promo-status {
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 700;
        }
        .status-active { background: #eaf7ee; color: #0d6a2b; }
        .status-upcoming { background: #fff4e6; color: #cc5c00; }
        .status-expired { background: #fdecec; color: #8d1e1e; }
        .promo-details {
            font-size: 14px;
            color: var(--muted);
            margin-bottom: 15px;
            line-height: 1.5;
        }
        .promo-meta {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--muted);
            margin-bottom: 15px;
        }
        .promo-actions {
            display: flex;
            gap: 8px;
        }
        .tier-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .tier-bronze { background-color: #e9d8c7; color: #8c6e4a; }
        .tier-silver { background-color: #e0e0e0; color: #6c757d; }
        .tier-gold { background-color: #f9e79f; color: #b7950b; }
        .chips button {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            background: #fff;
            border: 1px solid var(--bd);
            color: var(--muted);
        }
        .chips button.active {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary);
        }
        .modal {
            position: fixed;
            inset: 0;
            display: none;
            place-items: center;
            padding: 18px;
            z-index: 20;
        }
        .modal.show {
            display: grid;
        }
        .scrim {
            position: absolute;
            inset: 0;
            background: rgba(13,23,38,.35);
            backdrop-filter: blur(2px);
        }
        .sheet {
            position: relative;
            z-index: 1;
            width: min(860px,96vw);
            background: #fff;
            border: 1px solid var(--bd);
            border-radius: 18px;
            box-shadow: var(--shadow);
            padding: 16px 16px 12px;
            animation: pop .22s ease;
            max-height: 90vh;
            overflow-y: auto;
        }
        @keyframes pop {
            from { transform: translateY(10px); opacity: 0; }
            to { transform: none; opacity: 1; }
        }
        .sheet h3 {
            margin: 6px 6px 12px;
            font-size: 18px;
            font-weight: 700;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0,1fr));
            gap: 10px;
        }
        .col-2 { grid-column: span 2; }
        .field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .field label {
            font-size: 14px;
            font-weight: 600;
            color: var(--ink);
        }
        .field input, .field select, .field textarea {
            border: 1px solid var(--bd);
            border-radius: 10px;
            padding: 10px 12px;
            font-family: inherit;
            font-size: 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .field input:focus, .field select:focus, .field textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(53, 92, 255, 0.1);
        }
        .field textarea {
            resize: vertical;
            min-height: 80px;
        }
        .sheet .row {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 10px;
        }
        .toast {
            position: fixed;
            right: 14px;
            bottom: 14px;
            display: grid;
            gap: 8px;
            z-index: 30;
        }
        .toast .msg {
            background: #fff;
            border: 1px solid var(--bd);
            border-left: 4px solid var(--primary);
            box-shadow: var(--shadow);
            padding: 10px 12px;
            border-radius: 10px;
            font-weight: 600;
            transform: translateY(8px);
            opacity: 0;
            animation: toastIn .25s ease forwards;
        }
        .msg.ok { border-left-color: #16a34a; }
        .msg.err { border-left-color: #d94848; }
        @keyframes toastIn {
            to { transform: none; opacity: 1; }
        }
        .email-preview {
            background: #f8f9ff;
            border: 1px solid var(--bd);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .email-preview h4 {
            margin-bottom: 10px;
            color: var(--ink);
        }
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: var(--radius);
            height: 100px;
        }
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body>
<header>
    <div class="bar">
        <div class="brand">
            <div class="logo"></div>
            <h1>Loyalty Management System</h1>
            <span id="countBadge" class="badge">Dashboard</span>
        </div>
        <div class="actions">
            <button id="refreshBtn" class="btn-ghost" type="button">↻ Refresh</button>
            <button id="addPromoBtn" class="btn-primary" type="button">＋ Add Promotion</button>
        </div>
    </div>
</header>

<main>
    <div class="dashboard-tabs">
        <div class="dashboard-tab active" data-tab="dashboard">Dashboard</div>
        <div class="dashboard-tab" data-tab="members">Members</div>
        <div class="dashboard-tab" data-tab="promotions">Promotions</div>
    </div>

    <!-- Dashboard View -->
    <div id="dashboardView" class="tab-content">
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Members</h3>
                <div class="stat-value" id="totalMembers">0</div>
                <div class="stat-label">Active loyalty members</div>
            </div>
            <div class="stat-card">
                <h3>Active Promotions</h3>
                <div class="stat-value" id="activePromotions">0</div>
                <div class="stat-label">Running campaigns</div>
            </div>
            <div class="stat-card">
                <h3>Points Issued</h3>
                <div class="stat-value" id="pointsIssued">0</div>
                <div class="stat-label">This month</div>
            </div>
            <div class="stat-card">
                <h3>Redemption Rate</h3>
                <div class="stat-value" id="redemptionRate">0%</div>
                <div class="stat-label">Points used vs issued</div>
            </div>
        </div>

        <div class="toolbar">
            <h3>Recent Promotions</h3>
            <div class="actions">
                <button class="btn-ghost" id="viewAllPromos">View All</button>
            </div>
        </div>

        <div class="promotions-grid" id="recentPromotions">
            <div class="skeleton"></div>
            <div class="skeleton"></div>
            <div class="skeleton"></div>
        </div>
    </div>

    <!-- Members View -->
    <div id="membersView" class="tab-content" style="display: none;">
        <div class="toolbar">
            <div class="search">
                <span class="icon">🔎</span>
                <input id="memberSearch" placeholder="Search members by name, email, or ID..." />
            </div>
            <div class="actions chips">
                <button class="chip active" data-filter="all" type="button">All</button>
                <button class="chip" data-filter="bronze" type="button">Bronze</button>
                <button class="chip" data-filter="silver" type="button">Silver</button>
                <button class="chip" data-filter="gold" type="button">Gold</button>
            </div>
        </div>

        <div class="panel">
            <table aria-label="Members table">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Tier</th>
                    <th>Points</th>
                    <th>Flights</th>
                    <th>Last Activity</th>
                    <th style="width:200px">Actions</th>
                </tr>
                </thead>
                <tbody id="membersTable">
                <tr><td colspan="8"><div class="skeleton"></div></td></tr>
                <tr><td colspan="8"><div class="skeleton"></div></td></tr>
                <tr><td colspan="8"><div class="skeleton"></div></td></tr>
                </tbody>
            </table>
            <div id="membersEmpty" class="empty" style="display:none">No members found</div>
        </div>
    </div>

    <!-- Promotions View -->
    <div id="promotionsView" class="tab-content" style="display: none;">
        <div class="toolbar">
            <div class="search">
                <span class="icon">🔎</span>
                <input id="promoSearch" placeholder="Search promotions..." />
            </div>
            <div class="actions chips">
                <button class="chip active" data-status="all" type="button">All</button>
                <button class="chip" data-status="active" type="button">Active</button>
                <button class="chip" data-status="upcoming" type="button">Upcoming</button>
                <button class="chip" data-status="expired" type="button">Expired</button>
            </div>
        </div>

        <div class="promotions-grid" id="promotionsGrid">
            <div class="skeleton"></div>
            <div class="skeleton"></div>
            <div class="skeleton"></div>
        </div>
        <div id="promotionsEmpty" class="empty" style="display:none">No promotions found</div>
    </div>
</main>

<!-- Add Promotion Modal -->
<div id="promoModal" class="modal" aria-hidden="true">
    <div class="scrim" data-close></div>
    <div class="sheet">
        <h3 id="modalTitle">Create New Promotion</h3>
        <form id="promoForm" novalidate>
            <div class="form-grid">
                <div class="field col-2">
                    <label for="promo_title">Promotion Title *</label>
                    <input id="promo_title" maxlength="100" required placeholder="e.g., Double Points Weekend" />
                </div>
                <div class="field col-2">
                    <label for="promo_description">Description *</label>
                    <textarea id="promo_description" required placeholder="Describe the promotion..."></textarea>
                </div>
                <div class="field">
                    <label for="promo_type">Promotion Type *</label>
                    <select id="promo_type" required>
                        <option value="">Select type</option>
                        <option value="PERCENTAGE">Percentage Discount</option>
                        <option value="FIXED_AMOUNT">Fixed Amount</option>
                    </select>
                </div>
                <div class="field">
                    <label for="target_tier">Target Tier</label>
                    <select id="target_tier">
                        <option value="all">All Tiers</option>
                        <option value="bronze">Bronze Only</option>
                        <option value="silver">Silver Only</option>
                        <option value="gold">Gold Only</option>
                    </select>
                </div>
                <div class="field">
                    <label for="start_date">Start Date *</label>
                    <input id="start_date" type="date" required />
                </div>
                <div class="field">
                    <label for="end_date">End Date *</label>
                    <input id="end_date" type="date" required />
                </div>
                <div class="field">
                    <label for="points_value">Discount Amount *</label>
                    <input id="points_value" type="number" min="0" step="0.01" required placeholder="e.g., 25.00" />
                </div>
            </div>
            <div class="row">
                <button type="button" class="btn-ghost" data-close>Cancel</button>
                <button class="btn-primary" type="submit">Create Promotion</button>
            </div>
        </form>
    </div>
</div>

<!-- Send Email Modal -->
<div id="emailModal" class="modal" aria-hidden="true">
    <div class="scrim" data-close></div>
    <div class="sheet">
        <h3>Send Points Update Email</h3>
        <form id="emailForm" novalidate>
            <div class="form-grid">
                <div class="field col-2">
                    <label for="email_customer">Customer</label>
                    <select id="email_customer" required>
                        <option value="">Select a customer</option>
                    </select>
                </div>
                <div class="field">
                    <label for="email_points_earned">Points Earned *</label>
                    <input id="email_points_earned" type="number" min="0" required placeholder="0" />
                </div>
                <div class="field">
                    <label for="email_points_redeemed">Points Redeemed</label>
                    <input id="email_points_redeemed" type="number" min="0" placeholder="0" />
                </div>
                <div class="field col-2">
                    <label for="email_personal_message">Personal Message (optional)</label>
                    <textarea id="email_personal_message" placeholder="Add a personal note to the customer..."></textarea>
                </div>
            </div>

            <div class="email-preview" id="emailPreview">
                <h4>Email Preview:</h4>
                <div id="emailPreviewContent">Select a customer to see preview...</div>
            </div>

            <div class="row">
                <button type="button" class="btn-ghost" data-close>Cancel</button>
                <button class="btn-primary" type="submit">Send Email</button>
            </div>
        </form>
    </div>
</div>

<div id="toast" class="toast"></div>

<script>
    // Configuration
    const API_BASE = 'http://localhost:8080/api';
    let members = [];
    let promotions = [];

    // DOM Elements
    const toast = document.getElementById('toast');
    const promoModal = document.getElementById('promoModal');
    const emailModal = document.getElementById('emailModal');
    const promoForm = document.getElementById('promoForm');
    const emailForm = document.getElementById('emailForm');
    const dashboardTabs = document.querySelectorAll('.dashboard-tab');

    // Toast System
    function showToast(text, ok = true) {
        const el = document.createElement('div');
        el.className = 'msg ' + (ok ? 'ok' : 'err');
        el.textContent = text;
        toast.appendChild(el);
        setTimeout(() => el.remove(), 3000);
    }

    // Modal System
    function openModal(modal, data = null) {
        modal.classList.add('show');
        modal.setAttribute('aria-hidden', 'false');

        if (modal === emailModal && data) {
            document.getElementById('email_customer').value = data.id;
            updateEmailPreview();
        }
    }

    function closeModal(modal) {
        modal.classList.remove('show');
        modal.setAttribute('aria-hidden', 'true');
        if (modal === promoModal) {
            promoForm.reset();
            document.getElementById('modalTitle').textContent = 'Create New Promotion';
            promoForm.onsubmit = handleCreatePromotion;
        }
        if (modal === emailModal) emailForm.reset();
    }

    // Tab Navigation
    dashboardTabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const tabName = tab.dataset.tab;
            dashboardTabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
            document.getElementById(tabName + 'View').style.display = 'block';

            switch(tabName) {
                case 'dashboard': loadDashboardData(); break;
                case 'members': loadMembers(); break;
                case 'promotions': loadPromotions(); break;
            }
        });
    });

    // Data Loading Functions
    async function loadDashboardData() {
        try {
            console.log("Loading dashboard data...");
            const [stats, recentPromos] = await Promise.all([
                fetch(`${API_BASE}/dashboard/stats`).then(r => r.json()),
                fetch(`${API_BASE}/promotions/recent`).then(r => r.json())
            ]);

            console.log("Dashboard stats:", stats);
            console.log("Recent promotions:", recentPromos);

            document.getElementById('totalMembers').textContent = stats.totalMembers;
            document.getElementById('activePromotions').textContent = stats.activePromotions;
            document.getElementById('pointsIssued').textContent = stats.pointsIssued?.toLocaleString() || '0';
            document.getElementById('redemptionRate').textContent = (stats.redemptionRate || '0') + '%';

            displayRecentPromotions(recentPromos);
        } catch (error) {
            console.error('Dashboard load error:', error);
            showToast('Failed to load dashboard data', false);
        }
    }

    async function loadMembers() {
        try {
            console.log("Loading members...");
            const response = await fetch(`${API_BASE}/members`);
            if (!response.ok) throw new Error('Failed to load members');
            members = await response.json();
            console.log("Members loaded:", members.length);
            displayMembers(members);
        } catch (error) {
            console.error('Members load error:', error);
            showToast('Failed to load members', false);
        }
    }

    async function loadPromotions() {
        try {
            console.log("=== LOADING PROMOTIONS ===");

            // Clear previous content and show loading
            document.getElementById('promotionsGrid').innerHTML = `
                <div class="skeleton"></div>
                <div class="skeleton"></div>
                <div class="skeleton"></div>
            `;

            const response = await fetch(`${API_BASE}/promotions?t=${Date.now()}`);
            console.log("Response status:", response.status);

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }

            promotions = await response.json();
            console.log("Promotions loaded from API:", promotions);

            if (promotions.length === 0) {
                console.log("No promotions returned from API");
                document.getElementById('promotionsGrid').innerHTML = '<div class="empty">No promotions found</div>';
                document.getElementById('promotionsEmpty').style.display = 'block';
                return;
            }

            displayPromotions(promotions);
            document.getElementById('promotionsEmpty').style.display = 'none';

        } catch (error) {
            console.error('Promotions load error:', error);
            document.getElementById('promotionsGrid').innerHTML =
                `<div class="empty">Error loading promotions: ${error.message}</div>`;
            showToast('Failed to load promotions', false);
        }
    }

    // Display Functions
    function displayRecentPromotions(promos) {
        const container = document.getElementById('recentPromotions');
        if (!promos || promos.length === 0) {
            container.innerHTML = '<div class="empty">No recent promotions</div>';
            return;
        }

        container.innerHTML = promos.map(promo => `
                <div class="promo-card">
                    <div class="promo-header">
                        <div class="promo-title">${escapeHtml(promo.title)}</div>
                        <div class="promo-status status-${promo.status}">${promo.status}</div>
                    </div>
                    <div class="promo-details">${escapeHtml(promo.description)}</div>
                    <div class="promo-meta">
                        <span>${formatDate(promo.start_date)} - ${formatDate(promo.end_date)}</span>
                        <span>${promo.discount_amount} ${promo.discount_type}</span>
                    </div>
                </div>
            `).join('');
    }

    function displayMembers(membersList) {
        const container = document.getElementById('membersTable');
        const empty = document.getElementById('membersEmpty');
        const searchTerm = document.getElementById('memberSearch').value.toLowerCase();
        const filter = document.querySelector('.chips .active').dataset.filter;

        const filtered = membersList.filter(member => {
            const matchesSearch = !searchTerm ||
                member.name.toLowerCase().includes(searchTerm) ||
                member.email.toLowerCase().includes(searchTerm) ||
                member.customerId.toString().includes(searchTerm);

            const matchesFilter = filter === 'all' || member.tier.toLowerCase() === filter;

            return matchesSearch && matchesFilter;
        });

        if (filtered.length === 0) {
            container.innerHTML = '';
            empty.style.display = 'block';
            return;
        }

        empty.style.display = 'none';
        container.innerHTML = filtered.map(member => {
            const tierClass = `tier-${member.tier.toLowerCase()}`;
            return `
                    <tr>
                        <td>${member.id}</td>
                        <td><strong>${escapeHtml(member.name)}</strong></td>
                        <td>${escapeHtml(member.email)}</td>
                        <td><span class="tier-badge ${tierClass}">${member.tier}</span></td>
                        <td>${member.points.toLocaleString()}</td>
                        <td>${member.flights}</td>
                        <td>${formatDate(member.last_activity)}</td>
                        <td class="ops">
                            <button class="btn-mini btn-edit" onclick="openEmailModal(${member.id})">Email</button>
                            <button class="btn-mini btn-edit" onclick="updatePoints(${member.id})">Add Points</button>
                        </td>
                    </tr>
                `;
        }).join('');
    }

    function displayPromotions(promosList) {
        const container = document.getElementById('promotionsGrid');
        const empty = document.getElementById('promotionsEmpty');
        const searchTerm = document.getElementById('promoSearch').value.toLowerCase();
        const statusFilter = document.querySelector('.chips .active').dataset.status;

        const filtered = promosList.filter(promo => {
            const matchesSearch = !searchTerm ||
                promo.title.toLowerCase().includes(searchTerm) ||
                (promo.description && promo.description.toLowerCase().includes(searchTerm));

            const matchesStatus = statusFilter === 'all' || promo.status === statusFilter;

            return matchesSearch && matchesStatus;
        });

        if (filtered.length === 0) {
            container.innerHTML = '';
            empty.style.display = 'block';
            return;
        }

        empty.style.display = 'none';
        container.innerHTML = filtered.map(promo => `
                <div class="promo-card">
                    <div class="promo-header">
                        <div class="promo-title">${escapeHtml(promo.title)}</div>
                        <div class="promo-status status-${promo.status}">${promo.status}</div>
                    </div>
                    <div class="promo-details">${escapeHtml(promo.description)}</div>
                    <div class="promo-meta">
                        <span>${formatDate(promo.start_date)} - ${formatDate(promo.end_date)}</span>
                        <span>${promo.discount_amount} ${promo.discount_type}</span>
                    </div>
                    <div class="promo-actions">
                        <button class="btn-mini btn-edit" onclick="editPromotion(${promo.id})">Edit</button>
                        <button class="btn-mini btn-del" onclick="deletePromotion(${promo.id})">Delete</button>
                    </div>
                </div>
            `).join('');
    }

    // Promotion Form Handlers
    async function handleCreatePromotion(e) {
        e.preventDefault();
        console.log("=== CREATING PROMOTION ===");

        const formData = {
            title: document.getElementById('promo_title').value,
            description: document.getElementById('promo_description').value,
            promotion_type: document.getElementById('promo_type').value,
            target_tier: document.getElementById('target_tier').value,
            start_date: document.getElementById('start_date').value + 'T00:00:00',
            end_date: document.getElementById('end_date').value + 'T23:59:59',
            points_value: parseFloat(document.getElementById('points_value').value)
        };

        console.log('Form data:', formData);

        try {
            const response = await fetch(`${API_BASE}/promotions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(formData)
            });

            console.log("Create response status:", response.status);

            if (!response.ok) {
                const errorText = await response.text();
                console.error("Create error response:", errorText);
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }

            const result = await response.json();
            console.log('Promotion created successfully:', result);

            showToast('Promotion created successfully');
            closeModal(promoModal);

            // Force refresh promotions list
            await loadPromotions();

            // Also refresh dashboard to update counts
            loadDashboardData();

        } catch (error) {
            console.error('Error creating promotion:', error);
            showToast('Failed to create promotion: ' + error.message, false);
        }
    }

    async function handleUpdatePromotion(promoId, e) {
        e.preventDefault();
        console.log("Updating promotion:", promoId);

        const formData = {
            title: document.getElementById('promo_title').value,
            description: document.getElementById('promo_description').value,
            promotion_type: document.getElementById('promo_type').value,
            target_tier: document.getElementById('target_tier').value,
            start_date: document.getElementById('start_date').value + 'T00:00:00',
            end_date: document.getElementById('end_date').value + 'T23:59:59',
            points_value: parseFloat(document.getElementById('points_value').value)
        };

        try {
            const response = await fetch(`${API_BASE}/promotions/${promoId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(formData)
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }

            const result = await response.json();
            console.log('Promotion updated:', result);

            showToast('Promotion updated successfully');
            closeModal(promoModal);
            loadPromotions();

        } catch (error) {
            console.error('Error updating promotion:', error);
            showToast('Failed to update promotion: ' + error.message, false);
        }
    }

    // Email Functions
    function openEmailModal(memberId) {
        const member = members.find(m => m.id === memberId);
        if (!member) return;

        const customerSelect = document.getElementById('email_customer');
        customerSelect.innerHTML = '';
        members.forEach(m => {
            const option = document.createElement('option');
            option.value = m.id;
            option.textContent = `${m.name} (${m.email}) - ${m.points.toLocaleString()} points`;
            customerSelect.appendChild(option);
        });
        customerSelect.value = memberId;

        openModal(emailModal, member);
        updateEmailPreview();
    }

    function updateEmailPreview() {
        const memberId = document.getElementById('email_customer').value;
        const pointsEarned = parseInt(document.getElementById('email_points_earned').value) || 0;
        const pointsRedeemed = parseInt(document.getElementById('email_points_redeemed').value) || 0;
        const personalMessage = document.getElementById('email_personal_message').value;

        const member = members.find(m => m.id == memberId);
        if (!member) {
            document.getElementById('emailPreviewContent').textContent = 'Select a customer to see preview...';
            return;
        }

        const newPoints = member.points + pointsEarned - pointsRedeemed;

        document.getElementById('emailPreviewContent').innerHTML = `
                <p><strong>To:</strong> ${escapeHtml(member.email)}</p>
                <p><strong>Subject:</strong> Your Updated Points Balance</p>
                <p><strong>Message:</strong></p>
                <p>Dear ${escapeHtml(member.name)},</p>
                <p>Your points balance has been updated:</p>
                <ul>
                    <li>Previous Balance: ${member.points.toLocaleString()} points</li>
                    ${pointsEarned > 0 ? `<li>Points Earned: +${pointsEarned.toLocaleString()}</li>` : ''}
                    ${pointsRedeemed > 0 ? `<li>Points Redeemed: -${pointsRedeemed.toLocaleString()}</li>` : ''}
                    <li><strong>New Balance: ${newPoints.toLocaleString()} points</strong></li>
                </ul>
                ${personalMessage ? `<p><em>${escapeHtml(personalMessage)}</em></p>` : ''}
            `;
    }

    // Utility Functions
    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        try {
            return new Date(dateString).toLocaleDateString();
        } catch (e) {
            return 'Invalid Date';
        }
    }

    function escapeHtml(unsafe) {
        if (!unsafe) return '';
        return unsafe
            .toString()
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // Event Listeners
    document.getElementById('addPromoBtn').addEventListener('click', () => openModal(promoModal));
    document.getElementById('refreshBtn').addEventListener('click', () => {
        const activeTab = document.querySelector('.dashboard-tab.active').dataset.tab;
        switch(activeTab) {
            case 'dashboard': loadDashboardData(); break;
            case 'members': loadMembers(); break;
            case 'promotions': loadPromotions(); break;
        }
        showToast('Data refreshed');
    });

    document.getElementById('viewAllPromos').addEventListener('click', () => {
        document.querySelector('[data-tab="promotions"]').click();
    });

    // Search and filter listeners
    document.getElementById('memberSearch').addEventListener('input', () => displayMembers(members));
    document.getElementById('promoSearch').addEventListener('input', () => displayPromotions(promotions));

    document.querySelectorAll('.chips button').forEach(btn => {
        btn.addEventListener('click', function() {
            this.parentElement.querySelectorAll('button').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            if (this.closest('#membersView')) displayMembers(members);
            if (this.closest('#promotionsView')) displayPromotions(promotions);
        });
    });

    // Form submissions
    promoForm.addEventListener('submit', handleCreatePromotion);

    emailForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = {
            memberId: document.getElementById('email_customer').value,
            pointsEarned: parseInt(document.getElementById('email_points_earned').value) || 0,
            pointsRedeemed: parseInt(document.getElementById('email_points_redeemed').value) || 0,
            personalMessage: document.getElementById('email_personal_message').value
        };

        try {
            const pointsResponse = await fetch(`${API_BASE}/members/${formData.memberId}/points`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    pointsEarned: formData.pointsEarned,
                    pointsRedeemed: formData.pointsRedeemed
                })
            });

            if (!pointsResponse.ok) {
                const errorText = await pointsResponse.text();
                throw new Error(`Points update failed: ${errorText}`);
            }

            const emailResponse = await fetch(`${API_BASE}/email/points`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(formData)
            });

            if (!emailResponse.ok) {
                const errorText = await emailResponse.text();
                throw new Error(`Email send failed: ${errorText}`);
            }

            showToast('Points updated and email sent successfully');
            closeModal(emailModal);
            loadMembers();

        } catch (error) {
            console.error('Error in email form:', error);
            showToast('Failed to process request: ' + error.message, false);
        }
    });

    // Email form live updates
    document.getElementById('email_points_earned').addEventListener('input', updateEmailPreview);
    document.getElementById('email_points_redeemed').addEventListener('input', updateEmailPreview);
    document.getElementById('email_personal_message').addEventListener('input', updateEmailPreview);
    document.getElementById('email_customer').addEventListener('change', updateEmailPreview);

    // Modal close handlers
    document.querySelectorAll('.scrim, [data-close]').forEach(el => {
        el.addEventListener('click', (e) => {
            if (e.target.matches('[data-close], .scrim')) {
                closeModal(promoModal);
                closeModal(emailModal);
            }
        });
    });

    // Global functions
    window.updatePoints = async function(memberId) {
        const points = prompt('Enter points to add (use negative number to deduct):');
        if (points === null) return;

        const pointsNum = parseInt(points);
        if (isNaN(pointsNum)) {
            showToast('Please enter a valid number', false);
            return;
        }

        try {
            const requestBody = {
                pointsEarned: pointsNum > 0 ? pointsNum : 0,
                pointsRedeemed: pointsNum < 0 ? Math.abs(pointsNum) : 0
            };

            console.log("Updating points for member:", memberId, requestBody);

            const response = await fetch(`${API_BASE}/members/${memberId}/points`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }

            const result = await response.json();
            console.log('Points update result:', result);

            showToast('Points updated successfully');
            loadMembers();

        } catch (error) {
            console.error('Error updating points:', error);
            showToast('Failed to update points: ' + error.message, false);
        }
    };

    window.editPromotion = function(promoId) {
        const promo = promotions.find(p => p.id === promoId);
        if (!promo) {
            showToast('Promotion not found', false);
            return;
        }

        document.getElementById('promo_title').value = promo.title;
        document.getElementById('promo_description').value = promo.description;
        document.getElementById('promo_type').value = promo.promotion_type;
        document.getElementById('target_tier').value = promo.target_tier;

        if (promo.start_date) {
            document.getElementById('start_date').value = promo.start_date.substring(0, 10);
        }
        if (promo.end_date) {
            document.getElementById('end_date').value = promo.end_date.substring(0, 10);
        }

        document.getElementById('points_value').value = promo.discount_amount || '';

        document.getElementById('modalTitle').textContent = 'Edit Promotion';
        promoForm.onsubmit = (e) => handleUpdatePromotion(promoId, e);

        openModal(promoModal);
    };

    window.deletePromotion = async function(promoId) {
        console.log("=== DELETING PROMOTION ===");
        console.log("Promotion ID:", promoId);

        if (!confirm('Are you sure you want to delete this promotion?')) return;

        try {
            const response = await fetch(`${API_BASE}/promotions/${promoId}`, {
                method: 'DELETE'
            });

            console.log("Delete response status:", response.status);

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }

            const result = await response.json();
            console.log("Delete result:", result);

            showToast('Promotion deleted successfully');
            loadPromotions();

        } catch (error) {
            console.error('Error deleting promotion:', error);
            showToast('Failed to delete promotion: ' + error.message, false);
        }
    };

    // Set current date as default for start date
    document.getElementById('start_date').valueAsDate = new Date();

    // Set end date to 30 days from now
    const endDate = new Date();
    endDate.setDate(endDate.getDate() + 30);
    document.getElementById('end_date').valueAsDate = endDate;

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        console.log("Initializing application...");
        loadDashboardData();
        loadMembers();
        loadPromotions();
    });
</script>
</body>
</html>